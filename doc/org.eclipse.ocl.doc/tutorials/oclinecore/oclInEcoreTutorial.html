<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<link rel="Stylesheet" type="text/css" href="doc.css" />
	<title>Tutorial: Working with OCLinEcore</title>
</head>
<body>
<h1><a name="top">Tutorial: Working with OCLinEcore</a></h1>

<p>
This tutorial was written for Eclipse Helios; Eclipse 3.6, EMF 2.6, OCL 3.0.
</p>

<h2>Contents</h2>

<ul>
	<li><a href="#overview">Overview</a></li>
	<li><a href="#refs">References</a></li>
	<li><a href="#installation">Installing the MDT/OCL Examples</a></li>
	<li><a href="#ecore-editing">Using the OCLinEcore text editor for Ecore</a></li>
	<li><a href="#constraints">Parsing OCL Constraints</a></li>
	<li><a href="#evaluating">Evaluating OCL Expressions and Constraints</a></li>
	<li><a href="#contentassist">Content Assist Support</a></li>
	<li><a href="#ast">Working with the AST</a></li>
	<li><a href="#serialize">Serialization</a></li>
	<li><a href="#summary">Summary</a></li>
</ul>

<h2><a name="overview">Overview</a></h2>
<p>
In this example you will
<ul>
	<li>Create an Ecore model using the OCLinEcore text editor</li>
	<li>Create a dynamic instance of that Ecore model</li>
	<li>Enrich the Ecore model with OCL using the OCLinEcore text editor</li>
	<li>Validate the model and observe the OCL enrichments</li>
	<li>Use the OCL Console to execute the OCL enrichments</li>
</ul>
</p>
The above is all performed without generating any Java code;
the models exploit EMF's dynamic capabilities and the OCL integration.
<p>
You may then
<ul>
	<li>Create an Ecore genmodel</li>
	<li>Generate Java code for the Ecore model that invokes the OCL expressions.</li>
</ul>
</p>

<p class="small">[<a href="#top">back to top</a>]</p>

<h2><a name="refs">References</a></h2>
<p>
This tutorial assumes that the reader is familiar with generating models using EMF.
The reader is referred to <a href="../../../org.eclipse.emf.doc/tutorials/clibmod/clibmod.html">Generating an EMF Model</a>.
</p>
<p>
To see the complete source code for the examples shown in this tutorial, install
the <a href="../../references/examples/oclInterpreterExample.html">OCL Interpreter Example</a>
plug-in into your workspace.
</p>
<p>
Other references:
</p>
<ul>
	<li>
		For an environment in which to test the OCL expressions that you will create
		in this tutorial, install the
		<a href="../../references/examples/exampleOverview.html">Library Metamodel</a>
		example.
	</li>
	<li>
		<a target="_blank" href="http://www.omg.org/technology/documents/modeling_spec_catalog.htm#OCL">OCL 2.0</a> specification.
	</li>
</ul>
<p class="small">[<a href="#top">back to top</a>]</p>

<h2><a name="installation">Installing the MDT/OCL Examples</a></h2>
<p>
The OCLinEcore editor is not part of the core OCL functionality included in the
Modeling Package. 

...
</p>

<h2><a name="ecore-editing">Using the OCLinEcore text editor for Ecore</a></h2>
<p>
There are many different (comaptible) ways to create and edit Ecore models.
</p>
<ul>
	<li>An Ecore Model may be created from an XSD schema file</li>
	<li>An Ecore Model may be created from a Rose model file</li>
	<li>An Ecore Model may be created from annotated Java file</li>
	<li>The Sample Ecore Editor provides tree editing</li>
	<li>The Ecore Tools project provides graphical editing</li>
	<li>Papyrus provides a UML editing that may be converted to Ecore</li>
</ul>
Here we introduce the OCLinEcore editor that provides text editing, which is
appropriate when a non-trivial amount of OCL enrichment is required.
<p>
All the above approaches update an Ecore file, so the user is free to choose
whichever editing approach is best suited for the planned changes.
</p>
<h3><a name="new-project">Create a New EMF Project</a></h3>
<p>
We will first create a new project for this example; so invoke <b>File->New->Project...</b>
(left-click the <b>File</b> menu, then left-click <b>New</b>, then left-click <b>Project...</b>).
</p>
<p>
In the <b>New Project</b> dialog left-click to expand <b>Eclipse Modeling Framework</b>, then left-click to select
<b>Empty EMF Project</b> and finally left-click on <b>Finish</b>.
</p>
<p>
In the <b>New Empty EMF Project</b> dialog type <b>Tutorial</b> as the project name and left-click on <b>Finish</b>.
</p>

<h3><a name="new-model">Create a New Ecore Model</a></h3>
<p>
We will now create a new model for this example; so right-click on the <b>model</b> folder
in the <b>Tutorial</b> project to define the target folder and pop-up the context-sensitive menu
and select <b>New->Other...</b>.
</p>
<p>
In the <b>New</b> dialog left-click to expand <b>Eclipse Modeling Framework</b>, then left-click to select
<b>Ecore Model</b> and finally left-click on <b>Next</b>.
</p>
<p>
In the <b>New Ecore Model</b> dialog type <b>Tutorial.ecore</b> as the file name and left-click on <b>Finish</b>.
</p>
<p>
The <b>Sample Ecore</b> editor for <b>Tutorial.ecore</b> showing a tree view of a single unnamed <tt>EPackage</tt>.
</p>
<p>
Close the editor by left-clicking the cross on the editor tab.
</p>

<h3><a name="edit-model">Edit Ecore Model as OCLinEcore</a></h3>
<p>
We will now open the Ecore model using the OCLinEcore text editor and provide some
initial content.
</p>
<p>
Right-click on the <b>Tutorial.ecore</b> file to pop-up the context-sensitive menu
and select <b>Open With->OCLinEcore (Ecore) Editor</b>.
</p>
<img src="empty_ecore.png" alt="Empty Ecore Editor" />
<p>
The first time you open a file in the project with one of the Xtext-based editors, you
will be asked <b>Do you want the Xtext nature to be added to this project</b>. Click <b>Yes</b>
to avoid answering the question in the future.
</p>
<p>
An almost empty text file appears showing the package keyword and an empty name.
</p>
<img src="empty_oclinecore.png" alt="Empty OCLinEcore Editor" />
<p>
Now type (or cut and paste) the following text into the editor.
</p>
<pre class="Code">
import ecore : 'http://www.eclipse.org/emf/2002/Ecore#/';

package tutorial : tut = 'http://www.eclipse.org/mdt/ocl/oclinecore/tutorial'
{
  class Library
  {
    attribute name : String;
    property books#_'library' : Book[*] { composes };
    property loans : Loan[*] { composes };
    property members#_'library' : Member[*] { composes };
  }
  
  class Book
  {
    attribute name : String;
    attribute copies : Integer;
    property _'library'#books : Library;
  }
  
  class Member
  {
    attribute name : String;
    property _'library'#members : Library;
  }
  
  class Loan
  {
    property book : Book;
    property member : Member;
    attribute date : ecore::EDate;
  }
}
</pre>
<p>
The syntax is fairly self explanatory, emulating OMG specifications with
'name : type[multiplicity] { properties }'.
</p>
<ul>
	<li><tt>import</tt> associates an alias for an EPackage (hence the trailing #/ in the URI).</li>
	<li><tt>package</tt> introduces an EPackage with name, nsPrefix and nsURI.</li>
	<li><tt>class</tt> introduces an EClass with name and optional superclasses.</li>
	<li><tt>attribute</tt> introduces a property with a datatype type (an EAttribute).</li>
	<li><tt>property</tt> introduces a property with a class type (an EReference).</li>
	<li><tt>#</tt> introduces an opposite role name.</li>
	<li><tt>_'xxx'</tt> escapes an awkward or reserved word identifier.</li>
</ul>
<p>
Completion assist (Ctrl Space) may be used for syntax assistance. Alternatively,
the Sample Ecore Editor may be used to create a construct directly in Ecore,
which can then be opened in the OCLinEcore editor to see the corresponding
textual syntax.
</p>

<h3><a name="tutorial-meta-model">The Tutorial Meta-Model</a></h3>
<p>
The example meta-model models a library with members and books
and loans of books to members. It may be viewed graphically using the Ecore Tools
(not part of this tutorial).
</p>
<img src="ecore_diagram.png" alt="Ecore Diagram" />
<p>
The OCL types <tt>String</tt> and <tt>Integer</tt> map
to <tt>EString</tt> and <tt>EBigInteger</tt> in Ecore.
</p>

<p class="small">[<a href="#top">back to top</a>]</p>

<h2><a name="create-model">Create a Dynamic Model Instance</a></h2>
<p>
At this point a corresponding EMF tutorial would show how to generate Java code for
and an editor the meta-model. Here we are concerned with modeling, so we will 
continue with the models alone.
</p>
<p>
In the outline right-click on <b>Library</b> to show the context-sensitive menu
and then left-click on <b>Create Dynamic Instance...</b> to start to create a
new Dynamic Model with <tt>Library</tt> at its root.
</p>
<p>
(If the Outline is not visible, it may be made visible by <b>Window->Show View->Outline</b>.)
</p>
<p>
(If <tt>Library</tt> is not visible in the Outline, left-click on <b>OCLinEcore Document</b>
to expand it, then on <b>tutorial</b> to expand it.)
</p>
<img src="create_dynamic_instance.png" alt="Create Dynamic Instance" />
<p>
In the <b>Create Dynamic Instance</b> dialog select <tt>Tutorial/model</tt> as
the parent folder for the <tt>Tutorial.xmi</tt> dynamic model instance and left-click <b>Finish</b>.
</p>
<img src="create_dynamic_instance_dialog.png" alt="Create Dynamic Instance Dialog" />
<p>
The model is automatically opened for editing using the Sample Reflective Ecore Editor,
which gives a tree-like presentation of the model. The properties of each node can
be seen in the Properties View.
</p>
<img src="initial_model.png" alt="Initial Model" />
<p>
(If the Properties View is not visible, right-click within the editor and left-click on
<b>Show Properties View</b>.)
</p>
<p>
From the right-button menu <tt>Library</tt> use <b>New Child->Books Book</b> twice,
use <b>New Child->Loans Loan</b> once and <b>New Child->Members Member</b> three times
to populate the model with two books, one loan and three members. 
</p>
<p>
Left-click to select each of the Books and Members in turn and enter a name
such as <tt>b1</tt> or <tt>m2</tt> using the Properties View. Specify that b1
has one copy and that b2 has 2 copies.
</p>
<img src="model_copies.png" alt="Model Showing Copies" />
<p>
The books and members now have distinct titles in the outline, so that
when you left-click to select the Loan and edit its Book and Member attributes
the associated pull-down has meaningful entries. Specify that the Loan is for
<tt>b2</tt> by <tt>m3</tt>.
</p>
<img src="model_pull_down.png" alt="Model Pull-Down Menu" />
<p>
The configuration so far is simple, three members, two books and one loan. We can
validate that this by right-clicking on the Library node, and left-clicking Validate
to validate Library and all its children.
</p>
<img src="validate_menu.png" alt="Validate Menu" />
<p>
Since the model is so simple, it is difficult to have anything wrong; most of
the illegal modeling options such as a Loan composing rather than referencing a
Book are prevented by the Editor's enforcement of the meta-model.
</p>
<img src="validation_successful.png" alt="Validation Successful" />
<p>
(If you have an error at this point, a <b>Details</b> button will lead you to some
diagnostics that may clarify the problem.)
</p>
<p>
We will now create two further identical loans of <tt>b2</tt> by <tt>m3</tt>. This
may conveniently be performed by left-clicking to select the existing loan,
typing Ctrl-C to copy it, left-clicking to select the library as a new parent,
then typinf Ctrl-V to paste it on the library. Repeat so that there are three
identocal loans.
</p>
<p>
Validating the library should still be successful, although it is clearly wrong for
the two copies of <tt>b2</tt> to participate in three loans.
</p>

<p class="small">[<a href="#top">back to top</a>]</p>

<h2><a name="enrich-meta-model">Enrich the meta-model with OCL</a></h2>
<p>
The semantic constraint that a book cannot be borrowed more times than there are books
is a simple example of a constraint that cannot be expressed by simple multiplicities; 
a more powerful capability is required that may potentially require evaluation
of functions of almost arbitraty complexity. The Object Constraint Language
provides this capability.
</p>
<p>
The constraint can be realized as an invariant on a book that specifies that
that the size of the selection of loans involving the book is less than or equal
to the number of copies of the book.
</p>
<p>
Close the <tt>Tutorial.xmi</tt> editor before modifying its meta-model. Beware that
a wide variety of unpleasant errors can occur if the meta-model is changed after
the model is loaded.
</p>
<p>
Add the invariant shown below to the meta-model.
</p>
<pre class="Code">
  class Book
  {
    invariant SufficientCopies:
      library.loans->select(book=self)->size() <= copies;
    attribute name : String;
    attribute copies : Integer;
    property library#books : Library;
  }
</pre>
<p>
This is expressed by the <tt>SufficientCopies</tt> invariant constraint for a Book.
For a valid model the SufficientCopies invariant must always be true.
</p>
<p>
If you reopen the <tt>Tutorial.xmi</tt> editor and invoke Validate for the Library,
you will now get a validation error.
</p>
<img src="validation_unsuccessful.png" alt="Validation Unsuccessful" />
<p>
The <b>Details</b> identifies that the <tt>SufficientCopies</tt> invariant is not
satisfied for the <tt>b2</tt> book. 
</p>
<p>
If you now change one of the loans so that <tt>b1</tt> is borrowed and then validate
again, the problem is resolved. It is alright for <tt>m3</tt> to borrow
the one copy of <tt>b1</tt> and the two copies of <tt>b2</tt>.
</p>
<p>
Before introducing a further constraint of no duplicate loans, we will show
how OCL expressions can be exercised. OCL is a very powerful compact language;
the example hides a loop over all the loans. More complex examples may easily
involve three or four levels of hidden loopps on a single line, but may equally
easily have simple errors. It is therefore helpful to simplify expressions
and use helper operations and properties to modularise them. These may be
exercised using the OCL Console.
</p>

<p class="small">[<a href="#top">back to top</a>]</p>

<h2><a name="console">The OCL Console</a></h2>
<p>
The OCL Console supports interactive execution of an OCL expression in the
context of a model instance.
</p>
<p>
To make the OCL Console visible, first make the <b>Console</b> view visible by
<b>Window->Show View->Console</b>. Then right click on the <b>Open Console</b> and
left click on <b>Interactive OCL</b>.
</p>
<img src="ocl_console_menu.png" alt="OCL Console menu" />
<p>
The <b>Interactive OCL</b> console comprises two main text panes. The upper pane
displays results. The lower pane supports entry of queries.
</p>
<p>
Left-click to select the <tt>Library</tt> in the <b>Tutorila.xmi</b> as the context
for a query, and then type <tt>books</tt> followed by a new line into the lower
pane of the console. 
</p>
<p>
The result of evaluating this query for the Library is shown.
</p>
<img src="books_query.png" alt="Books Query" />
<p>
Substantial OCL queries spanning many lines may be entered and so the cursor up
and cursor down keys move across lines. If you want to access an earlier query,
you may use the <b>Page Up</b> or <b>Page Down</b> keys to save typing them again.
</p>
<p>
You can examine the execution of the earlier query by selecting each of the books
in turn and executing <tt>library.loans->select(book=self)</tt>, to see that <tt>b1</tt>
has one Loan and <tt>b2</tt> two.
</p>
<p>
(Practising queries in this way is particularly important with MDT/OCL 3.0.0 since
validation of expression types is not performed in the editor. You may therefore
enter erroneous OCL without warning from the editor and get an OclInvalid
result from execution. Step-wise practice can resolve this. The next MDT/OCL
release will have this missing validation.)
</p>
<p>
We will now introduce some help attributes and operations to make
the OCL clearer and provide a richer meta-model API.
Close the <tt>Tutorial.xmi</tt> editor and modify the meta-model to include
the derived <tt>loans</tt> property and the helper operation <tt>isAvailable()</tt>.
Simplify the invariant to use the derived property.
</p>
<pre class="Code">
  class Book
  {
    invariant SufficientCopies: 
      loans->size() <= copies;
    attribute name : String[?];
    attribute copies : Integer[?];
    property loans : Loan[*] { derived,volatile }
    {
      derivation: library.loans->select(book=self);
    }
    property _'library'#books : Library[?];
    operation isAvailable() : Boolean[?]
    {
      body: loans->size() < copies;
    }
  }
</pre>
<p>
BUG. The derived property must also be volatile to avoid problems when
a model is loaded but has no content.
</p>
<p>
The derived property is visible in the <b>Properties</b> view.
</p>
<img src="derived_property.png" alt="Derived Property" />
<p>
The helper operation can be evaluated in the <b>Console</b> view.
</p>
<img src="helper_operation.png" alt="Helper Operation" />

<p>
We will now further helpers and constraints to enforce an
at most two loans per member policy.
</p>
<p>
(Don't forget to close <tt>tutorial.xmi</tt> while changing its meta-model.)
</p>
<pre class="Code">  class Member
  {
    invariant AtMostTwoLoans: 
      loans->size() <= 2;
    attribute name : String[?];
    property _'library'#members : Library[?];
    property loans : Loan[*] { derived,volatile }
    {
      derivation: library.loans->select(member=self);
    }
    property books : Book[*] { derived,volatile }
    {
      derivation: loans->collect(book);
    }
  }
</pre>
<p>
The additional <tt>books</tt> property may be evaluated in the OCL
Console to show which books each member has on loan.
</p>
<p>
BUG. The <tt>books</tt> property is not evaluated in the <b>Properties</b> view.
</p>

<p class="small">[<a href="#top">back to top</a>]</p>

<h2><a name="summary">Summary</a></h2>
<p>
To illustrate how to work with the OCL API, we
</p>
<ol>
	<li>Parsed and validated OCL expressions and constraints.</li>
	<li>Evaluated OCL query expressions and constraints.</li>
	<li>Obtained content-assist suggestions for the completion of OCL expressions.</li>
	<li>Transformed an OCL expression AST using the <i>Visitor</i> pattern.</li>
	<li>Saved and loaded OCL expressions to/from XMI resources.</li>
</ol>
<p class="small">[<a href="#top">back to top</a>]</p>

<hr />

<p><a href="http://www.eclipse.org/legal/epl-v10.html">Copyright (c) 2010 E.D.Willink and others. All Rights Reserved.</a></p>
</body>
</html>
