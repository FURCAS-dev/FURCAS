#!/bin/sh
if [ "$1" = "" ]; then
  echo Usage: $0 \<eclipse_dir\ [\<LIBS_dir\>]]
  echo Launch with your workspace root being the current working directory.
  echo Runs you through a rebase of the MOIN patches for the Last Known Good
  echo release of date YEAR_MM_DD.
  echo If \<eclipse_dir\> is not provided, it defaults to c:/apps/eclipse.
  echo If \<LIBS_dir\> is not provided, it defaults to $TMP/libs
else

  if [ "$1" = "" ]; then
    ECLIPSE_INSTALLATION="c:/apps/eclipse"
  else
    ECLIPSE_INSTALLATION="$1"
  fi
  if [ "$2" = "" ]; then
    LIBS="$TMP/libs"
  else
    LIBS="$2"
  fi
  mkdir -p "$LIBS"
  # The following line includes all test projects as well, but those don't seem to be available as standard plugins;
  # may need to get from Perforce...
  # PROJECTS="com.sap.mi.basic.facade com.sap.mi.dii.facade com.sap.mi.facade com.sap.mi.fwk com.sap.mi.fwk.dcfwk com.sap.mi.fwk.services.local com.sap.mi.fwk.test com.sap.mi.fwk.test.service com.sap.mi.fwk.test.service.ui com.sap.mi.fwk.ui com.sap.mi.fwk.ui.test com.sap.mi.gfw com.sap.mi.gfw.eclipse com.sap.mi.gfw.mm.eclipse com.sap.mi.gfw.samples com.sap.mi.gfw.test com.sap.mi.graphics.facade com.sap.mi.performancetests.moftool com.sap.mi.test.facade com.sap.mi.tools.cockpit.editor com.sap.mi.tools.cockpit.editor.test com.sap.mi.tools.cockpit.mql com.sap.mi.tools.cockpit.mql.test com.sap.mi.tools.diagnostics com.sap.mi.tools.diagnostics.test com.sap.mi.tools.metamodelbuilder com.sap.mi.tools.metamodelbuilder.test com.sap.mi.tools.mmdeployment com.sap.mi.tools.mmdeployment.test com.sap.mi.tools.oclevalview com.sap.mi.tools.oclevalview.test com.sap.tc.moin.facility.build.libraries com.sap.tc.moin.facility.primary com.sap.tc.moin.facility.primary.generic.facade com.sap.tc.moin.facility.primary.ide.facade com.sap.tc.moin.facility.primary.internal com.sap.tc.moin.facility.primary.libraries com.sap.tc.moin.facility.primary.libraries.api com.sap.tc.moin.facility.primary.libraries.fs com.sap.tc.moin.facility.primary.spi com.sap.tc.moin.friends.api com.sap.tc.moin.friends.di.facade com.sap.tc.moin.friends.factory com.sap.tc.moin.friends.ide.facade com.sap.tc.moin.friends.ide.factory com.sap.tc.moin.ide.facade com.sap.tc.moin.jmi com.sap.tc.moin.libraries.api com.sap.tc.moin.libraries.base com.sap.tc.moin.libraries.buildplugin com.sap.tc.moin.libraries.core com.sap.tc.moin.libraries.generic.facade com.sap.tc.moin.libraries.jmi com.sap.tc.moin.libraries.jmi.facade com.sap.tc.moin.libraries.spi com.sap.tc.moin.libraries.spi.facade com.sap.tc.moin.libraries.spi.internal com.sap.tc.moin.metamodel.company com.sap.tc.moin.metamodel.generatedmetamodel com.sap.tc.moin.metamodel.gfw com.sap.tc.moin.metamodel.jmitck com.sap.tc.moin.metamodel.mc com.sap.tc.moin.metamodel.serviceinteractions com.sap.tc.moin.metamodel.testcases com.sap.tc.moin.metamodel.testcases.foundation com.sap.tc.moin.metamodel.textverticalization com.sap.tc.moin.metamodel.util com.sap.tc.moin.nomm.cpstest com.sap.tc.moin.nwdi.dctype com.sap.tc.moin.nwdi.dctype.mm com.sap.tc.moin.query.client com.sap.tc.moin.query.dihelper com.sap.tc.moin.query.repositoryhelper com.sap.tc.moin.repository.test.MoinTestEclipsePlugin com.sap.tc.moin.runtime com.sap.tc.moin.test.di.dctype com.sap.tc.moin.test.di.dctype.dummy com.sap.tc.moin.test.friends.epi com.sap.tc.moin.test.metamodel.plugins.wrapper.epi com.sap.tc.moin.test.queryclient.etf com.sap.tc.moin.testfw.epi com.sap.tc.moin.versioning.di com.sap.tc.moin.xm.generation"
  
  # The following line contains those projects available as plugins from the update site:
  #PROJECTS="com.sap.mi.basic.facade com.sap.mi.dii.facade com.sap.mi.facade com.sap.mi.fwk com.sap.mi.fwk.dcfwk com.sap.mi.fwk.services.local com.sap.mi.fwk.test.service com.sap.mi.fwk.test.service.ui com.sap.mi.fwk.ui com.sap.mi.gfw com.sap.mi.gfw.eclipse com.sap.mi.gfw.mm.eclipse com.sap.mi.graphics.facade com.sap.mi.test.facade com.sap.mi.tools.cockpit.editor com.sap.mi.tools.cockpit.mql com.sap.mi.tools.diagnostics com.sap.mi.tools.metamodelbuilder com.sap.mi.tools.mmdeployment com.sap.mi.tools.oclevalview com.sap.tc.moin.facility.build.libraries com.sap.tc.moin.facility.primary com.sap.tc.moin.facility.primary.generic.facade com.sap.tc.moin.facility.primary.ide.facade com.sap.tc.moin.facility.primary.libraries com.sap.tc.moin.facility.primary.libraries.api com.sap.tc.moin.facility.primary.libraries.fs com.sap.tc.moin.facility.primary.spi com.sap.tc.moin.friends.api com.sap.tc.moin.friends.di.facade com.sap.tc.moin.friends.factory com.sap.tc.moin.friends.ide.facade com.sap.tc.moin.friends.ide.factory com.sap.tc.moin.ide.facade com.sap.tc.moin.incubation.contentprovider com.sap.tc.moin.incubation.jdfacility.epi com.sap.tc.moin.incubation.mm com.sap.tc.moin.incubation.pffacility.epi com.sap.tc.moin.incubation.sampledata.epi com.sap.tc.moin.jmi com.sap.tc.moin.libraries.api com.sap.tc.moin.libraries.base com.sap.tc.moin.libraries.buildplugin com.sap.tc.moin.libraries.core com.sap.tc.moin.libraries.generic.facade com.sap.tc.moin.libraries.jmi com.sap.tc.moin.libraries.jmi.facade com.sap.tc.moin.libraries.spi com.sap.tc.moin.libraries.spi.facade com.sap.tc.moin.libraries.spi.internal com.sap.tc.moin.metamodel.textverticalization com.sap.tc.moin.metamodel.util com.sap.tc.moin.nwdi.dctype com.sap.tc.moin.nwdi.dctype.mm com.sap.tc.moin.query.client com.sap.tc.moin.query.repositoryhelper com.sap.tc.moin.runtime com.sap.tc.moin.versioning.di com.sap.tc.moin.xm.generation com.sap.mi.fwk.test com.sap.mi.fwk.ui.test com.sap.mi.gfw.test com.sap.mi.tools.cockpit.editor.test com.sap.mi.tools.cockpit.mql.test com.sap.mi.tools.diagnostics.test com.sap.mi.tools.metamodelbuilder.test com.sap.mi.tools.mmdeployment.test com.sap.mi.tools.oclevalview.test com.sap.tc.moin.metamodel.testcases com.sap.tc.moin.metamodel.testcases.foundation com.sap.tc.moin.test.friends.epi com.sap.tc.moin.test.metamodel.plugins.wrapper.epi com.sap.tc.moin.test.queryclient.etf com.sap.tc.moin.testfw.epi com.sap.tc.moin.repository.test.MoinTestEclipsePlugin"

  # These are only the test projects added later
  #PROJECTS="com.sap.mi.fwk.test com.sap.mi.fwk.ui.test com.sap.mi.gfw.test com.sap.mi.tools.cockpit.editor.test com.sap.mi.tools.cockpit.mql.test com.sap.mi.tools.diagnostics.test com.sap.mi.tools.metamodelbuilder.test com.sap.mi.tools.mmdeployment.test com.sap.mi.tools.oclevalview.test com.sap.tc.moin.metamodel.testcases com.sap.tc.moin.metamodel.testcases.foundation com.sap.tc.moin.test.friends.epi com.sap.tc.moin.test.metamodel.plugins.wrapper.epi com.sap.tc.moin.test.queryclient.etf com.sap.tc.moin.repository.test.MoinTestEclipsePlugin"
  
  PROJECTS="com.sap.tc.moin.repository.test.MoinTestEclipsePlugin"
  
  echo It is assumed that you have updated the plugins listed below to a new
  echo revision, e.g., from an update site. If this is not the case, please
  echo do so before continuing.
  echo This script will guide you through the process of putting the new
  echo version of the plugins into your workspace as unpacked plugin
  echo projects which you can then check in on the trunk as the new base
  echo release.
  # Backup a consistent snapshot of all libraries required by MOIN
  echo Copying dependent libraries to $LIBS
  pushd "$ECLIPSE_INSTALLATION/plugins"
  cp `for i in \`find . -maxdepth 1 \( -name 'com.sap.lalrparsergenerator*.jar' -o -name 'org.custommonkey.xmlunit*.jar' -o -name 'com.sap.ide.eclipse.ext.libs.yfiles*.jar' -o -name 'com.sap.stringtemplate*.jar' \) | sed -e 's/_[0-9].[0-9].[0-9]\(.[0-9]*\)\?\(_DevEfficiencyPatch\)\?\.jar//' | sort -u\`; do ls -tr $i*.jar | tail -n 1; done` "$LIBS"
  popd
  echo Please import the following plugins into your workspace:
  for i in $PROJECTS; do
    echo $i
  done
  echo When done, press ENTER to continue...
  read
  for i in $PROJECTS; do
    cd $i
    mkdir src
    cd src
    echo Unpacking JAR files of plugin project $i into src/ folder
    for j in ../*.jar ../lib/*.jar ../lib/private/*.jar; do
      jar xvf $j
    done
    rm -rf ../lib ../*.jar
    echo Removing .class files from src/ folder for project $i
    find . -type f -name '*.class' -exec rm "{}" \;
    rm -rf META-INF/ TEST-INF/ plugin.* build.properties fragment.xml sap-japro* resources/ launch/
    cd ../..
    echo Done with project $i
  done
  for i in $PROJECTS; do
    cat $i/META-INF/MANIFEST.MF | sed -e '/Bundle-ClassPath: \./d' >$i/META-INF/MANIFEST.MF.sed
    mv $i/META-INF/MANIFEST.MF.sed $i/META-INF/MANIFEST.MF
    echo "source.. = src/
output.. = bin/
bin.includes = META-INF/,\
               .,\
               plugin.xml" >$i/build.properties
    #cat $i/build.properties | sed -e 's/^\( *\)\.\(,\\\)* *$/\1bin\/\2/' >$i/build.properties.sed
    #mv $i/build.properties.sed $i/build.properties
  done
  echo Patching .classpath files...
  for i in $PROJECTS; do
     cd $i
     cat .classpath | sed -e 's/<classpathentry exported="true" kind="lib" path=".*\.jar" sourcepath=".*"\/>/<classpathentry kind="src" path="src"\/>/' >.classpath.sed
     mv .classpath.sed .classpath
     cd ..
  done
  echo Done patching .classpath files
  echo Please select the following projects in your Eclipse workspace and
  echo press F5 \(refresh\). Then, use Team--Share, then Team--Commit to
  echo commit them to the versioning repository.
  for i in $PROJECTS; do
    echo $i
  done
fi
